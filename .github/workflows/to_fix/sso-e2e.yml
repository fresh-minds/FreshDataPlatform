name: SSO E2E

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"
  pull_request:
    paths:
      - "ops/keycloak/**"
      - "airflow/webserver_config.py"
      - "docker-compose.yml"
      - "k8s/**/keycloak.yaml"
      - "k8s/**/airflow-webserver.yaml"
      - "k8s/**/minio.yaml"
      - ".env.template"
      - "tests/sso/**"
      - "scripts/sso/**"
      - "scripts/run_sso_tests.sh"
      - "Makefile"
      - ".github/workflows/sso-e2e.yml"

permissions:
  contents: read

jobs:
  sso-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 75

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure keycloak host resolves locally
        run: |
          echo "127.0.0.1 keycloak" | sudo tee -a /etc/hosts

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m venv .venv
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install -e ".[dev]"

      - name: Set CI environment
        run: |
          python - <<'PY'
          import os, secrets, base64
          fernet = base64.urlsafe_b64encode(secrets.token_bytes(32)).decode()
          env_lines = {
              "AIRFLOW_DB_USER": "airflow_app",
              "AIRFLOW_DB_PASSWORD": "airflow_app_pass_123",
              "AIRFLOW_DB_NAME": "airflow",
              "AIRFLOW_FERNET_KEY": fernet,
              "AIRFLOW_ADMIN_USER": "admin",
              "AIRFLOW_ADMIN_PASSWORD": "admin_secure_123",
              "AIRFLOW_ADMIN_EMAIL": "admin@example.com",
              "MINIO_ROOT_USER": "minio_admin",
              "MINIO_ROOT_PASSWORD": "minio_secure_123",
              "WAREHOUSE_DB": "freshminds_dw",
              "WAREHOUSE_USER": "warehouse_app",
              "WAREHOUSE_PASSWORD": "warehouse_secure_123",
              "SUPERSET_SECRET_KEY": "superset_secret_key_for_ci",
              "SUPERSET_DB_USER": "superset_app",
              "SUPERSET_DB_PASSWORD": "superset_secure_123",
              "SUPERSET_DB_NAME": "superset",
              "SUPERSET_ADMIN_USER": "admin",
              "SUPERSET_ADMIN_PASSWORD": "superset_admin_secure_123",
              "SUPERSET_ADMIN_EMAIL": "admin@superset.com",
              "DATAHUB_MYSQL_DATABASE": "datahub",
              "DATAHUB_MYSQL_USER": "datahub_app",
              "DATAHUB_MYSQL_PASSWORD": "datahub_secure_123",
              "DATAHUB_MYSQL_ROOT_PASSWORD": "datahub_root_secure_123",
              "DATAHUB_FRONTEND_SECRET": "datahub_frontend_secret_ci",
              "KEYCLOAK_ADMIN_USER": "admin",
              "KEYCLOAK_ADMIN_PASSWORD": "admin_secure_123",
              "KEYCLOAK_DEFAULT_USER_PASSWORD": "odp_admin_secure_123",
              "KEYCLOAK_AIRFLOW_CLIENT_ID": "airflow",
              "KEYCLOAK_AIRFLOW_CLIENT_SECRET": "keycloak_airflow_secret_ci",
              "KEYCLOAK_DATAHUB_CLIENT_ID": "datahub",
              "KEYCLOAK_DATAHUB_CLIENT_SECRET": "keycloak_datahub_secret_ci",
              "KEYCLOAK_MINIO_CLIENT_ID": "minio",
              "KEYCLOAK_MINIO_CLIENT_SECRET": "keycloak_minio_secret_ci",
              "KEYCLOAK_OIDC_BASE_URL": "http://keycloak:8090/realms/odp/protocol/openid-connect",
              "KEYCLOAK_OIDC_AUTHORIZE_URL": "http://keycloak:8090/realms/odp/protocol/openid-connect/auth",
              "KEYCLOAK_OIDC_BROWSER_AUTHORIZE_URL": "http://keycloak:8090/realms/odp/protocol/openid-connect/auth",
              "KEYCLOAK_OIDC_TOKEN_URL": "http://keycloak:8090/realms/odp/protocol/openid-connect/token",
              "KEYCLOAK_OIDC_DISCOVERY_URL": "http://keycloak:8090/realms/odp/.well-known/openid-configuration",
              "MINIO_OIDC_REDIRECT_URI": "http://localhost:9001/oauth_callback",
              "KEYCLOAK_BASE_URL": "http://keycloak:8090",
              "KEYCLOAK_REALM": "odp",
              "TEST_USER_BASIC": "odp-admin",
              "TEST_USER_BASIC_PASSWORD": "odp_admin_secure_123",
              "TEST_USER_ADMIN": "admin",
              "TEST_USER_ADMIN_PASSWORD": "admin_secure_123",
              "SSO_BROWSERS": "chromium",
              "SSO_REQUIRE_PKCE": "true",
              "SSO_EXPECT_GLOBAL_LOGOUT": "false",
              "SSO_EXPECT_REFRESH_ROTATION": "false",
              "SSO_ENVIRONMENT": "dev",
              "SSO_INSTALL_PLAYWRIGHT_BROWSERS": "false",
          }
          with open(os.environ["GITHUB_ENV"], "a") as f:
              for k, v in env_lines.items():
                  f.write(f"{k}={v}\n")
          PY

      - name: Install Playwright browsers
        run: .venv/bin/playwright install --with-deps chromium

      - name: Start platform stack
        run: docker compose up -d

      - name: Wait for SSO endpoints
        run: |
          for i in {1..90}; do
            if curl -sf http://keycloak:8090/realms/odp/.well-known/openid-configuration >/dev/null \
              && curl -sf http://localhost:8080/health >/dev/null \
              && curl -sf http://localhost:9001 >/dev/null \
              && curl -sf http://localhost:9002 >/dev/null; then
              echo "SSO endpoints are ready"
              exit 0
            fi
            echo "Waiting for SSO endpoints... ($i/90)"
            sleep 5
          done
          echo "Timed out waiting for SSO endpoints" >&2
          docker compose ps
          exit 1

      - name: Run SSO E2E suite
        run: make test-sso

      - name: Upload SSO artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sso-e2e-artifacts
          path: |
            tests/sso/artifacts/latest
            sso-test-report.md
            sso-test-inventory.md

      - name: Dump service status on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --tail=250

      - name: Tear down stack
        if: always()
        run: docker compose down -v
