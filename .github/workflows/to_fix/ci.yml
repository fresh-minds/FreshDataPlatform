name: CI

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      python_changed: ${{ steps.changes.outputs.python }}
      frontend_changed: ${{ steps.changes.outputs.frontend }}
      infra_changed: ${{ steps.changes.outputs.infra }}
      tests_changed: ${{ steps.changes.outputs.tests }}
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            python:
              - "pyproject.toml"
              - "setup.cfg"
              - "shared/**"
              - "pipelines/**"
              - "scripts/**"
              - "dags/**"
              - "tests/**"
            frontend:
              - "frontend/**"
            infra:
              - "airflow/**"
              - "ops/**"
              - "k8s/**"
              - "docker-compose*.yml"
              - "Dockerfile*"
            tests:
              - "tests/**"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Export version outputs
        id: version
        run: |
          python - <<'PY'
          import tomllib
          from pathlib import Path
          data = tomllib.loads(Path("pyproject.toml").read_text())
          version = data["project"]["version"]
          short_sha = __import__("subprocess").check_output(["git", "rev-parse", "--short", "HEAD"]).decode().strip()
          with open(Path.cwd() / "version.txt", "w") as f:
              f.write(f"{version}\n{short_sha}\n")
          PY
          echo "version=$(head -n1 version.txt)" >> "$GITHUB_OUTPUT"
          echo "short_sha=$(tail -n1 version.txt)" >> "$GITHUB_OUTPUT"
        shell: bash

  lint-python:
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.python_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: Ruff lint
        run: make lint

      - name: Ruff format check
        run: make format-check

  typecheck-python:
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.python_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: Mypy type check
        run: mypy --ignore-missing-imports shared/ pipelines/

  lint-frontend:
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.frontend_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: ESLint
        run: |
          cd frontend
          npm run lint

      - name: Prettier check
        run: |
          cd frontend
          npm run format:check

  unit-tests:
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.python_changed == 'true' || needs.preflight.outputs.tests_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          mkdir -p reports
          pytest tests/ -m "not e2e and not pipeline_e2e" -vv \
            --junitxml=reports/junit.xml \
            --cov=shared --cov=pipelines \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: reports

  integration-smoke:
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.infra_changed == 'true' || needs.preflight.outputs.tests_changed == 'true'
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set CI environment
        run: |
          python - <<'PY'
          import os, secrets, base64
          fernet = base64.urlsafe_b64encode(secrets.token_bytes(32)).decode()
          env_lines = {
              "AIRFLOW_DB_USER": "airflow_app",
              "AIRFLOW_DB_PASSWORD": "airflow_app_pass_123",
              "AIRFLOW_DB_NAME": "airflow",
              "AIRFLOW_FERNET_KEY": fernet,
              "AIRFLOW_ADMIN_USER": "admin",
              "AIRFLOW_ADMIN_PASSWORD": "admin_secure_123",
              "AIRFLOW_ADMIN_EMAIL": "admin@example.com",
              "MINIO_ROOT_USER": "minio_admin",
              "MINIO_ROOT_PASSWORD": "minio_secure_123",
              "WAREHOUSE_DB": "freshminds_dw",
              "WAREHOUSE_USER": "warehouse_app",
              "WAREHOUSE_PASSWORD": "warehouse_secure_123",
              "SUPERSET_SECRET_KEY": "superset_secret_key_for_ci",
              "SUPERSET_DB_USER": "superset_app",
              "SUPERSET_DB_PASSWORD": "superset_secure_123",
              "SUPERSET_DB_NAME": "superset",
              "SUPERSET_ADMIN_USER": "admin",
              "SUPERSET_ADMIN_PASSWORD": "superset_admin_secure_123",
              "SUPERSET_ADMIN_EMAIL": "admin@superset.com",
              "DATAHUB_MYSQL_DATABASE": "datahub",
              "DATAHUB_MYSQL_USER": "datahub_app",
              "DATAHUB_MYSQL_PASSWORD": "datahub_secure_123",
              "DATAHUB_MYSQL_ROOT_PASSWORD": "datahub_root_secure_123",
              "DATAHUB_FRONTEND_SECRET": "datahub_frontend_secret_ci",
              "KEYCLOAK_AIRFLOW_CLIENT_SECRET": "keycloak_airflow_secret_ci",
              "KEYCLOAK_DATAHUB_CLIENT_SECRET": "keycloak_datahub_secret_ci",
              "KEYCLOAK_MINIO_CLIENT_SECRET": "keycloak_minio_secret_ci",
          }
          with open(os.environ["GITHUB_ENV"], "a") as f:
              for k, v in env_lines.items():
                  f.write(f"{k}={v}\n")
          PY

      - name: Start platform stack
        run: docker compose up -d

      - name: Wait for core endpoints
        run: bash scripts/testing/ci_wait_for_services.sh

      - name: Dump service status on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --tail=200

      - name: Tear down stack
        if: always()
        run: docker compose down -v

  build-python:
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.python_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Build distributions
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Upload python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: dist

  build-frontend:
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.frontend_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Upload frontend dist
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
