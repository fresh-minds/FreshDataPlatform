============================= test session starts ==============================
platform darwin -- Python 3.9.6, pytest-8.4.2, pluggy-1.6.0 -- /Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial/.venv/bin/python3
cachedir: .pytest_cache
metadata: {'Python': '3.9.6', 'Platform': 'macOS-26.2-arm64-arm-64bit', 'Packages': {'pytest': '8.4.2', 'pluggy': '1.6.0'}, 'Plugins': {'anyio': '4.12.1', 'mock': '3.15.1', 'metadata': '3.1.1', 'html': '4.2.0', 'cov': '7.0.0'}}
rootdir: /Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial
configfile: pyproject.toml
plugins: anyio-4.12.1, mock-3.15.1, metadata-3.1.1, html-4.2.0, cov-7.0.0
collecting ... collected 22 items

tests/sso/test_api_authorization.py::test_access_token_claim_mapping FAILED [  4%]
tests/sso/test_api_authorization.py::test_keycloak_userinfo_authorization PASSED [  9%]
tests/sso/test_api_authorization.py::test_keycloak_admin_api_requires_elevated_role PASSED [ 13%]
tests/sso/test_api_authorization.py::test_configured_protected_api_matrix SKIPPED [ 18%]
tests/sso/test_browser_flows.py::test_unauthenticated_access_redirects_to_keycloak[chromium] FAILED [ 22%]
tests/sso/test_browser_flows.py::test_login_establishes_session_for_each_app[chromium] FAILED [ 27%]
tests/sso/test_browser_flows.py::test_cross_app_sso_uses_existing_session[chromium] PASSED [ 31%]
tests/sso/test_browser_flows.py::test_logout_propagation_matches_expected_design[chromium] FAILED [ 36%]
tests/sso/test_browser_flows.py::test_session_expiry_behavior[chromium] SKIPPED [ 40%]
tests/sso/test_browser_flows.py::test_mfa_prompt_or_completion[chromium] SKIPPED [ 45%]
tests/sso/test_negative_security.py::test_redirect_uri_injection_rejected PASSED [ 50%]
tests/sso/test_negative_security.py::test_invalid_code_verifier_rejected PASSED [ 54%]
tests/sso/test_negative_security.py::test_token_substitution_audience_protection PASSED [ 59%]
tests/sso/test_negative_security.py::test_clock_skew_handling_sanity PASSED [ 63%]
tests/sso/test_negative_security.py::test_refresh_token_rotation_behavior SKIPPEDrue|false to enforce)) [ 68%]
tests/sso/test_negative_security.py::test_logout_capabilities_discovery PASSED [ 72%]
tests/sso/test_smoke_config.py::test_openid_configuration_reachable_for_each_realm PASSED [ 77%]
tests/sso/test_smoke_config.py::test_jwks_endpoint_reachable_and_keys_parseable PASSED [ 81%]
tests/sso/test_smoke_config.py::test_client_redirect_uris_match_inventory FAILED [ 86%]
tests/sso/test_smoke_config.py::test_auth_code_pkce_token_exchange_per_client FAILED [ 90%]
tests/sso/test_smoke_config.py::test_https_enforcement_when_required SKIPPED [ 95%]
tests/sso/test_smoke_config.py::test_logout_endpoint_published PASSED    [100%]

=================================== FAILURES ===================================
_______________________ test_access_token_claim_mapping ________________________

sso_settings = SSOSettings(repo_root=PosixPath('/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial')...ng/production/ai_trial/ops/keycloak/odp-realm.json'), session_idle_timeout_seconds=None, run_session_expiry_test=False)
keycloak_metadata = {'authorization_endpoint': 'http://localhost:8090/realms/odp/protocol/openid-connect/auth', 'end_session_endpoint': 'h... 'http://localhost:8090/realms/odp', 'jwks_uri': 'http://localhost:8090/realms/odp/protocol/openid-connect/certs', ...}
issued_tokens = {'basic': {'_meta': {'auth_url': 'http://localhost:8090/realms/odp/protocol/openid-connect/auth?client_id=airflow&redi...eoyp6noLQzOyfuEISmSMLdH3gA6Ff9I7InUqO1RqvHOGCEFfEC43qK-fRQbacaOGAxkiqPKGQZOvowZ55t74vXw', 'not-before-policy': 0, ...}}
first_app = SSOApp(name='airflow', base_url='http://localhost:8080', client_id='airflow', client_secret='change_me_keycloak_airflo...lector="a:has-text('keycloak'), button:has-text('keycloak')", logout_url='http://localhost:8080/logout/', enabled=True)
write_log = <function write_log.<locals>._write at 0x107f23310>

    @pytest.mark.e2e
    def test_access_token_claim_mapping(
        sso_settings: SSOSettings,
        keycloak_metadata: dict[str, object],
        issued_tokens: dict[str, dict[str, Any]],
        first_app: SSOApp,
        write_log: object,
    ) -> None:
        access_token = issued_tokens["basic"]["access_token"]
        claims = decode_jwt_claims(access_token)
    
        expected_issuer = str(keycloak_metadata["issuer"])
        assert claims.get("iss") == expected_issuer, "Unexpected issuer claim"
    
        aud_claim = claims.get("aud")
        if isinstance(aud_claim, list):
            assert aud_claim, "aud claim list is empty"
        else:
>           assert isinstance(aud_claim, str) and aud_claim, "aud claim missing"
E           AssertionError: aud claim missing
E           assert (False)
E            +  where False = isinstance(None, str)

tests/sso/test_api_authorization.py:106: AssertionError
_________ test_unauthenticated_access_redirects_to_keycloak[chromium] __________

browser_name = 'chromium'
browser_context_factory = <function browser_context_factory.<locals>._create at 0x10f2128b0>
sso_settings = SSOSettings(repo_root=PosixPath('/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial')...ng/production/ai_trial/ops/keycloak/odp-realm.json'), session_idle_timeout_seconds=None, run_session_expiry_test=False)
write_log = <function write_log.<locals>._write at 0x10f4c8e50>

    @pytest.mark.e2e
    def test_unauthenticated_access_redirects_to_keycloak(
        browser_name: str,
        browser_context_factory: object,
        sso_settings: SSOSettings,
        write_log: object,
    ) -> None:
        for app in sso_settings.apps:
            context = browser_context_factory(f"{browser_name}-{app.name}-unauth")
            page = context.new_page()
    
            auth_url = navigate_to_login(page, app, sso_settings.keycloak_base_url)
            auth_query = query_params(auth_url)
    
            assert auth_query.get("client_id") == app.client_id, f"{app.name} did not use expected client_id"
            assert auth_query.get("response_type") == "code", f"{app.name} did not use auth code flow"
    
            if sso_settings.require_pkce:
>               assert auth_query.get("code_challenge"), f"{app.name} auth request missing code_challenge"
E               AssertionError: airflow auth request missing code_challenge
E               assert None
E                +  where None = <built-in method get of dict object at 0x10f5808c0>('code_challenge')
E                +    where <built-in method get of dict object at 0x10f5808c0> = {'response_type': 'code', 'client_id': 'airflow', 'redirect_uri': 'http://localhost:8080/oauth-authorized/keycloak', 'scope': 'openid profile email', 'state': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuZXh0IjpbImh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9ob21lIl19.gW4fwo1NXf7IND1o1BaiWxsib8kaW4zNCAENlJNglDA', 'nonce': '2ynQ9taYC4ONyPSghBuj'}.get

tests/sso/test_browser_flows.py:54: AssertionError
____________ test_login_establishes_session_for_each_app[chromium] _____________

browser_name = 'chromium'
browser_context_factory = <function browser_context_factory.<locals>._create at 0x10f512c10>
sso_settings = SSOSettings(repo_root=PosixPath('/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial')...ng/production/ai_trial/ops/keycloak/odp-realm.json'), session_idle_timeout_seconds=None, run_session_expiry_test=False)

    @pytest.mark.e2e
    def test_login_establishes_session_for_each_app(
        browser_name: str,
        browser_context_factory: object,
        sso_settings: SSOSettings,
    ) -> None:
        for app in sso_settings.apps:
            context = browser_context_factory(f"{browser_name}-{app.name}-login")
            page = context.new_page()
    
            navigate_to_login(page, app, sso_settings.keycloak_base_url)
            perform_keycloak_login(page, sso_settings.basic_user.username, sso_settings.basic_user.password)
            wait_for_app_return(page, app, sso_settings.keycloak_base_url)
    
            keycloak_cookies = context.cookies(sso_settings.keycloak_base_url)
>           assert any(cookie["name"].startswith("KEYCLOAK_") for cookie in keycloak_cookies), (
                f"{app.name} login did not establish Keycloak session cookie"
            )
E           AssertionError: airflow login did not establish Keycloak session cookie
E           assert False
E            +  where False = any(<generator object test_login_establishes_session_for_each_app.<locals>.<genexpr> at 0x10f5b69e0>)

tests/sso/test_browser_flows.py:77: AssertionError
__________ test_logout_propagation_matches_expected_design[chromium] ___________

browser_name = 'chromium'
browser_context_factory = <function browser_context_factory.<locals>._create at 0x10f5fb5e0>
sso_settings = SSOSettings(repo_root=PosixPath('/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial')...ng/production/ai_trial/ops/keycloak/odp-realm.json'), session_idle_timeout_seconds=None, run_session_expiry_test=False)
app_map = {'airflow': SSOApp(name='airflow', base_url='http://localhost:8080', client_id='airflow', client_secret='change_me_key...th_callback', login_trigger_selector="button:has-text('OpenID'), a:has-text('OpenID')", logout_url=None, enabled=True)}

    @pytest.mark.e2e
    def test_logout_propagation_matches_expected_design(
        browser_name: str,
        browser_context_factory: object,
        sso_settings: SSOSettings,
        app_map: dict[str, SSOApp],
    ) -> None:
        if not sso_settings.cross_app_pairs:
            pytest.skip("No cross-app pairs configured")
    
        expect_global_logout = os.getenv("SSO_EXPECT_GLOBAL_LOGOUT", "true").lower() in {"1", "true", "yes", "on"}
        source_name, target_name = sso_settings.cross_app_pairs[0]
    
        source_app = app_map[source_name]
        target_app = app_map[target_name]
    
        if not source_app.logout_url:
            pytest.skip(f"Logout URL not configured for source app '{source_app.name}'")
    
        context = browser_context_factory(f"{browser_name}-{source_name}-logout-propagation")
        page_a = context.new_page()
        navigate_to_login(page_a, source_app, sso_settings.keycloak_base_url)
        perform_keycloak_login(page_a, sso_settings.basic_user.username, sso_settings.basic_user.password)
        wait_for_app_return(page_a, source_app, sso_settings.keycloak_base_url)
    
        page_b = context.new_page()
        page_b.goto(target_app.base_url, wait_until="domcontentloaded")
        if target_app.login_trigger_selector:
            try:
                login_trigger = page_b.locator(target_app.login_trigger_selector).first
                if login_trigger.is_visible(timeout=1200):
                    login_trigger.click()
            except Exception:  # noqa: BLE001
                pass
    
        page_a.goto(source_app.logout_url, wait_until="domcontentloaded")
        page_b.goto(target_app.base_url, wait_until="domcontentloaded")
    
        reauth_required = _is_reauth_required(page_b, target_app, sso_settings.keycloak_base_url)
        if expect_global_logout:
>           assert reauth_required, (
                f"Logout in {source_app.name} did not require re-authentication in {target_app.name}"
            )
E           AssertionError: Logout in airflow did not require re-authentication in minio
E           assert False

tests/sso/test_browser_flows.py:166: AssertionError
__________________ test_client_redirect_uris_match_inventory ___________________

sso_settings = SSOSettings(repo_root=PosixPath('/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial')...ng/production/ai_trial/ops/keycloak/odp-realm.json'), session_idle_timeout_seconds=None, run_session_expiry_test=False)

    @pytest.mark.e2e
    def test_client_redirect_uris_match_inventory(sso_settings: SSOSettings) -> None:
        realm_import_path: Path = sso_settings.realm_import_path
        if not realm_import_path.exists():
            pytest.skip(f"Realm import file not found: {realm_import_path}")
    
        realm_payload = json.loads(realm_import_path.read_text(encoding="utf-8"))
        clients = {client["clientId"]: client for client in realm_payload.get("clients", [])}
    
        for app in sso_settings.apps:
            client = clients.get(app.client_id)
            assert client is not None, f"Client '{app.client_id}' missing from realm import file"
    
            redirect_uris = set(client.get("redirectUris", []))
            assert app.redirect_uri in redirect_uris, (
                f"{app.name} redirect URI '{app.redirect_uri}' missing for client '{app.client_id}'. "
                f"Found={sorted(redirect_uris)}"
            )
    
            if app.name in {"airflow", "datahub", "minio"}:
                web_origins = set(client.get("webOrigins", []))
>               assert "*" not in web_origins, (
                    f"Client '{app.client_id}' uses wildcard webOrigins. "
                    "Replace '*' with explicit origins to reduce token leakage and CORS risk."
                )
E               AssertionError: Client 'airflow' uses wildcard webOrigins. Replace '*' with explicit origins to reduce token leakage and CORS risk.
E               assert '*' not in {'*'}

tests/sso/test_smoke_config.py:73: AssertionError
________________ test_auth_code_pkce_token_exchange_per_client _________________

sso_settings = SSOSettings(repo_root=PosixPath('/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial')...ng/production/ai_trial/ops/keycloak/odp-realm.json'), session_idle_timeout_seconds=None, run_session_expiry_test=False)
write_log = <function write_log.<locals>._write at 0x10f6ca280>

    @pytest.mark.e2e
    def test_auth_code_pkce_token_exchange_per_client(sso_settings: SSOSettings, write_log: object) -> None:
        if not sso_settings.basic_user.username or not sso_settings.basic_user.password:
            pytest.skip("Basic user credentials are missing")
    
        for app in sso_settings.apps:
            tokens = fetch_tokens_auth_code_pkce(
                keycloak_base_url=sso_settings.keycloak_base_url,
                realm=sso_settings.keycloak_primary_realm,
                client_id=app.client_id,
                client_secret=app.client_secret,
                redirect_uri=app.redirect_uri,
                username=sso_settings.basic_user.username,
                password=sso_settings.basic_user.password,
            )
    
            auth_query = extract_authorization_query(str(tokens["_meta"]["auth_url"]))
            if sso_settings.require_pkce:
                assert auth_query.get("code_challenge"), f"PKCE code_challenge missing for {app.name}"
                assert auth_query.get("code_challenge_method") == "S256", f"PKCE method is not S256 for {app.name}"
    
            assert auth_query.get("response_type") == "code", f"{app.name} is not using authorization code flow"
            assert auth_query.get("client_id") == app.client_id, f"Unexpected client_id in auth flow for {app.name}"
    
            access_token = tokens.get("access_token")
            assert access_token, f"Token endpoint did not return access_token for {app.name}"
    
            claims = decode_jwt_claims(access_token)
            for required_claim in ("iss", "aud", "azp", "exp", "iat", "sub"):
>               assert required_claim in claims, f"Missing {required_claim} claim in access token for {app.name}"
E               AssertionError: Missing aud claim in access token for airflow
E               assert 'aud' in {'exp': 1771396553, 'iat': 1771396253, 'auth_time': 1771396253, 'jti': 'e58b3e95-7ff2-4c30-b634-c6cb5d41c6d0', 'iss': 'http://localhost:8090/realms/odp', 'sub': 'd17bf29a-f67c-432f-9be5-f87df4c1c98a', 'typ': 'Bearer', 'azp': 'airflow', 'sid': '9d01a392-1c99-4e59-848b-860de807278f', 'acr': '1', 'allowed-origins': ['*'], 'scope': 'openid email profile', 'email_verified': True, 'name': 'ODP Admin', 'preferred_username': 'odp-admin', 'given_name': 'ODP', 'family_name': 'Admin', 'email': 'admin@example.com'}

tests/sso/test_smoke_config.py:108: AssertionError
- generated xml file: /Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial/tests/sso/artifacts/junit-20260218T063039Z.xml -
=========================== short test summary info ============================
FAILED tests/sso/test_api_authorization.py::test_access_token_claim_mapping - AssertionError: aud claim missing
assert (False)
 +  where False = isinstance(None, str)
FAILED tests/sso/test_browser_flows.py::test_unauthenticated_access_redirects_to_keycloak[chromium] - AssertionError: airflow auth request missing code_challenge
assert None
 +  where None = <built-in method get of dict object at 0x10f5808c0>('code_challenge')
 +    where <built-in method get of dict object at 0x10f5808c0> = {'response_type': 'code', 'client_id': 'airflow', 'redirect_uri': 'http://localhost:8080/oauth-authorized/keycloak', 'scope': 'openid profile email', 'state': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuZXh0IjpbImh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9ob21lIl19.gW4fwo1NXf7IND1o1BaiWxsib8kaW4zNCAENlJNglDA', 'nonce': '2ynQ9taYC4ONyPSghBuj'}.get
FAILED tests/sso/test_browser_flows.py::test_login_establishes_session_for_each_app[chromium] - AssertionError: airflow login did not establish Keycloak session cookie
assert False
 +  where False = any(<generator object test_login_establishes_session_for_each_app.<locals>.<genexpr> at 0x10f5b69e0>)
FAILED tests/sso/test_browser_flows.py::test_logout_propagation_matches_expected_design[chromium] - AssertionError: Logout in airflow did not require re-authentication in minio
assert False
FAILED tests/sso/test_smoke_config.py::test_client_redirect_uris_match_inventory - AssertionError: Client 'airflow' uses wildcard webOrigins. Replace '*' with explicit origins to reduce token leakage and CORS risk.
assert '*' not in {'*'}
FAILED tests/sso/test_smoke_config.py::test_auth_code_pkce_token_exchange_per_client - AssertionError: Missing aud claim in access token for airflow
assert 'aud' in {'exp': 1771396553, 'iat': 1771396253, 'auth_time': 1771396253, 'jti': 'e58b3e95-7ff2-4c30-b634-c6cb5d41c6d0', 'iss': 'http://localhost:8090/realms/odp', 'sub': 'd17bf29a-f67c-432f-9be5-f87df4c1c98a', 'typ': 'Bearer', 'azp': 'airflow', 'sid': '9d01a392-1c99-4e59-848b-860de807278f', 'acr': '1', 'allowed-origins': ['*'], 'scope': 'openid email profile', 'email_verified': True, 'name': 'ODP Admin', 'preferred_username': 'odp-admin', 'given_name': 'ODP', 'family_name': 'Admin', 'email': 'admin@example.com'}
=================== 6 failed, 11 passed, 5 skipped in 12.83s ===================
