<?xml version="1.0" encoding="utf-8"?><testsuites name="pytest tests"><testsuite name="pytest" errors="0" failures="4" skipped="5" tests="22" time="10.145" timestamp="2026-02-18T07:41:30.951701+01:00" hostname="Karels-MacBook-Pro.local"><testcase classname="tests.sso.test_api_authorization" name="test_access_token_claim_mapping" time="0.177" /><testcase classname="tests.sso.test_api_authorization" name="test_keycloak_userinfo_authorization" time="0.024" /><testcase classname="tests.sso.test_api_authorization" name="test_keycloak_admin_api_requires_elevated_role" time="0.071" /><testcase classname="tests.sso.test_api_authorization" name="test_configured_protected_api_matrix" time="0.003"><skipped type="pytest.skip" message="No protected API matrix configured (SSO_API_MATRIX_JSON)">/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial/tests/sso/test_api_authorization.py:187: No protected API matrix configured (SSO_API_MATRIX_JSON)</skipped></testcase><testcase classname="tests.sso.test_browser_flows" name="test_unauthenticated_access_redirects_to_keycloak[chromium]" time="1.596"><failure message="AssertionError: airflow auth request missing code_challenge&#10;assert None&#10; +  where None = &lt;built-in method get of dict object at 0x10f16fb00&gt;('code_challenge')&#10; +    where &lt;built-in method get of dict object at 0x10f16fb00&gt; = {'response_type': 'code', 'client_id': 'airflow', 'redirect_uri': 'http://localhost:8080/oauth-authorized/keycloak', 'scope': 'openid profile email', 'state': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuZXh0IjpbImh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9ob21lIl19.j1juMYyRNfb172d1eEFZ03N3__G1DHBoiyj0BtAhdbY', 'nonce': 'HCObAhLClRSZ5Ni49cHe'}.get">browser_name = 'chromium'
browser_context_factory = &lt;function browser_context_factory.&lt;locals&gt;._create at 0x107ded940&gt;
sso_settings = SSOSettings(repo_root=PosixPath('/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial')...ng/production/ai_trial/ops/keycloak/odp-realm.json'), session_idle_timeout_seconds=None, run_session_expiry_test=False)
write_log = &lt;function write_log.&lt;locals&gt;._write at 0x10f0a6ee0&gt;

    @pytest.mark.e2e
    def test_unauthenticated_access_redirects_to_keycloak(
        browser_name: str,
        browser_context_factory: object,
        sso_settings: SSOSettings,
        write_log: object,
    ) -&gt; None:
        for app in sso_settings.apps:
            context = browser_context_factory(f"{browser_name}-{app.name}-unauth")
            page = context.new_page()
    
            auth_url = navigate_to_login(page, app, sso_settings.keycloak_base_url)
            auth_query = query_params(auth_url)
    
            assert auth_query.get("client_id") == app.client_id, f"{app.name} did not use expected client_id"
            assert auth_query.get("response_type") == "code", f"{app.name} did not use auth code flow"
    
            if sso_settings.require_pkce:
&gt;               assert auth_query.get("code_challenge"), f"{app.name} auth request missing code_challenge"
E               AssertionError: airflow auth request missing code_challenge
E               assert None
E                +  where None = &lt;built-in method get of dict object at 0x10f16fb00&gt;('code_challenge')
E                +    where &lt;built-in method get of dict object at 0x10f16fb00&gt; = {'response_type': 'code', 'client_id': 'airflow', 'redirect_uri': 'http://localhost:8080/oauth-authorized/keycloak', 'scope': 'openid profile email', 'state': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuZXh0IjpbImh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9ob21lIl19.j1juMYyRNfb172d1eEFZ03N3__G1DHBoiyj0BtAhdbY', 'nonce': 'HCObAhLClRSZ5Ni49cHe'}.get

tests/sso/test_browser_flows.py:54: AssertionError</failure></testcase><testcase classname="tests.sso.test_browser_flows" name="test_login_establishes_session_for_each_app[chromium]" time="1.143"><failure message="AssertionError: airflow login did not establish Keycloak session cookie&#10;assert False&#10; +  where False = any(&lt;generator object test_login_establishes_session_for_each_app.&lt;locals&gt;.&lt;genexpr&gt; at 0x10f1ea970&gt;)">browser_name = 'chromium'
browser_context_factory = &lt;function browser_context_factory.&lt;locals&gt;._create at 0x10f1e9820&gt;
sso_settings = SSOSettings(repo_root=PosixPath('/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial')...ng/production/ai_trial/ops/keycloak/odp-realm.json'), session_idle_timeout_seconds=None, run_session_expiry_test=False)

    @pytest.mark.e2e
    def test_login_establishes_session_for_each_app(
        browser_name: str,
        browser_context_factory: object,
        sso_settings: SSOSettings,
    ) -&gt; None:
        for app in sso_settings.apps:
            context = browser_context_factory(f"{browser_name}-{app.name}-login")
            page = context.new_page()
    
            navigate_to_login(page, app, sso_settings.keycloak_base_url)
            perform_keycloak_login(page, sso_settings.basic_user.username, sso_settings.basic_user.password)
            wait_for_app_return(page, app, sso_settings.keycloak_base_url)
    
            keycloak_cookies = context.cookies(sso_settings.keycloak_base_url)
&gt;           assert any(cookie["name"].startswith("KEYCLOAK_") for cookie in keycloak_cookies), (
                f"{app.name} login did not establish Keycloak session cookie"
            )
E           AssertionError: airflow login did not establish Keycloak session cookie
E           assert False
E            +  where False = any(&lt;generator object test_login_establishes_session_for_each_app.&lt;locals&gt;.&lt;genexpr&gt; at 0x10f1ea970&gt;)

tests/sso/test_browser_flows.py:77: AssertionError</failure></testcase><testcase classname="tests.sso.test_browser_flows" name="test_cross_app_sso_uses_existing_session[chromium]" time="4.658"><failure message="AssertionError: SSO from airflow to datahub prompted for credentials&#10;assert not True&#10; +  where True = page_has_keycloak_login_prompt(&lt;Page url='http://keycloak:8090/realms/odp/protocol/openid-connect/auth?scope=openid%20profile%20email&amp;response_type=code&amp;redirect_uri=http%3A%2F%2Flocalhost%3A9002%2Fcallback%2Foidc&amp;state=c64e38f703&amp;code_challenge_method=S256&amp;client_id=datahub&amp;code_challenge=hxd8GcFMolevJRPBqWmldrCd-T7IPfN2UkN_Ipa2-Zw'&gt;)">browser_name = 'chromium'
browser_context_factory = &lt;function browser_context_factory.&lt;locals&gt;._create at 0x10f0f4dc0&gt;
sso_settings = SSOSettings(repo_root=PosixPath('/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial')...ng/production/ai_trial/ops/keycloak/odp-realm.json'), session_idle_timeout_seconds=None, run_session_expiry_test=False)
app_map = {'airflow': SSOApp(name='airflow', base_url='http://localhost:8080', client_id='airflow', client_secret='change_me_key...th_callback', login_trigger_selector="button:has-text('OpenID'), a:has-text('OpenID')", logout_url=None, enabled=True)}

    @pytest.mark.e2e
    def test_cross_app_sso_uses_existing_session(
        browser_name: str,
        browser_context_factory: object,
        sso_settings: SSOSettings,
        app_map: dict[str, SSOApp],
    ) -&gt; None:
        if not sso_settings.cross_app_pairs:
            pytest.skip("No cross-app pairs configured")
    
        for source_name, target_name in sso_settings.cross_app_pairs:
            source_app = app_map[source_name]
            target_app = app_map[target_name]
    
            context = browser_context_factory(f"{browser_name}-{source_name}-to-{target_name}-sso")
            page_a = context.new_page()
            navigate_to_login(page_a, source_app, sso_settings.keycloak_base_url)
            perform_keycloak_login(page_a, sso_settings.basic_user.username, sso_settings.basic_user.password)
            wait_for_app_return(page_a, source_app, sso_settings.keycloak_base_url)
    
            page_b = context.new_page()
            page_b.goto(target_app.base_url, wait_until="domcontentloaded")
    
            if target_app.login_trigger_selector:
                try:
                    login_trigger = page_b.locator(target_app.login_trigger_selector).first
                    if login_trigger.is_visible(timeout=1200):
                        login_trigger.click()
                except Exception:  # noqa: BLE001
                    pass
    
            if is_keycloak_auth_url(page_b.url, sso_settings.keycloak_base_url):
&gt;               assert not page_has_keycloak_login_prompt(page_b), (
                    f"SSO from {source_app.name} to {target_app.name} prompted for credentials"
                )
E               AssertionError: SSO from airflow to datahub prompted for credentials
E               assert not True
E                +  where True = page_has_keycloak_login_prompt(&lt;Page url='http://keycloak:8090/realms/odp/protocol/openid-connect/auth?scope=openid%20profile%20email&amp;response_type=code&amp;redirect_uri=http%3A%2F%2Flocalhost%3A9002%2Fcallback%2Foidc&amp;state=c64e38f703&amp;code_challenge_method=S256&amp;client_id=datahub&amp;code_challenge=hxd8GcFMolevJRPBqWmldrCd-T7IPfN2UkN_Ipa2-Zw'&gt;)

tests/sso/test_browser_flows.py:116: AssertionError</failure></testcase><testcase classname="tests.sso.test_browser_flows" name="test_logout_propagation_matches_expected_design[chromium]" time="1.768"><failure message="AssertionError: Logout in airflow did not require re-authentication in minio&#10;assert False">browser_name = 'chromium'
browser_context_factory = &lt;function browser_context_factory.&lt;locals&gt;._create at 0x107945e50&gt;
sso_settings = SSOSettings(repo_root=PosixPath('/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial')...ng/production/ai_trial/ops/keycloak/odp-realm.json'), session_idle_timeout_seconds=None, run_session_expiry_test=False)
app_map = {'airflow': SSOApp(name='airflow', base_url='http://localhost:8080', client_id='airflow', client_secret='change_me_key...th_callback', login_trigger_selector="button:has-text('OpenID'), a:has-text('OpenID')", logout_url=None, enabled=True)}

    @pytest.mark.e2e
    def test_logout_propagation_matches_expected_design(
        browser_name: str,
        browser_context_factory: object,
        sso_settings: SSOSettings,
        app_map: dict[str, SSOApp],
    ) -&gt; None:
        if not sso_settings.cross_app_pairs:
            pytest.skip("No cross-app pairs configured")
    
        expect_global_logout = os.getenv("SSO_EXPECT_GLOBAL_LOGOUT", "true").lower() in {"1", "true", "yes", "on"}
        source_name, target_name = sso_settings.cross_app_pairs[0]
    
        source_app = app_map[source_name]
        target_app = app_map[target_name]
    
        if not source_app.logout_url:
            pytest.skip(f"Logout URL not configured for source app '{source_app.name}'")
    
        context = browser_context_factory(f"{browser_name}-{source_name}-logout-propagation")
        page_a = context.new_page()
        navigate_to_login(page_a, source_app, sso_settings.keycloak_base_url)
        perform_keycloak_login(page_a, sso_settings.basic_user.username, sso_settings.basic_user.password)
        wait_for_app_return(page_a, source_app, sso_settings.keycloak_base_url)
    
        page_b = context.new_page()
        page_b.goto(target_app.base_url, wait_until="domcontentloaded")
        if target_app.login_trigger_selector:
            try:
                login_trigger = page_b.locator(target_app.login_trigger_selector).first
                if login_trigger.is_visible(timeout=1200):
                    login_trigger.click()
            except Exception:  # noqa: BLE001
                pass
    
        page_a.goto(source_app.logout_url, wait_until="domcontentloaded")
        page_b.goto(target_app.base_url, wait_until="domcontentloaded")
    
        reauth_required = _is_reauth_required(page_b, target_app, sso_settings.keycloak_base_url)
        if expect_global_logout:
&gt;           assert reauth_required, (
                f"Logout in {source_app.name} did not require re-authentication in {target_app.name}"
            )
E           AssertionError: Logout in airflow did not require re-authentication in minio
E           assert False

tests/sso/test_browser_flows.py:166: AssertionError</failure></testcase><testcase classname="tests.sso.test_browser_flows" name="test_session_expiry_behavior[chromium]" time="0.000"><skipped type="pytest.skip" message="Session expiry test disabled (SSO_RUN_SESSION_EXPIRY_TEST=false)">/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial/tests/sso/test_browser_flows.py:182: Session expiry test disabled (SSO_RUN_SESSION_EXPIRY_TEST=false)</skipped></testcase><testcase classname="tests.sso.test_browser_flows" name="test_mfa_prompt_or_completion[chromium]" time="0.000"><skipped type="pytest.skip" message="MFA user not configured">/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial/tests/sso/test_browser_flows.py:211: MFA user not configured</skipped></testcase><testcase classname="tests.sso.test_negative_security" name="test_redirect_uri_injection_rejected" time="0.027" /><testcase classname="tests.sso.test_negative_security" name="test_invalid_code_verifier_rejected" time="0.065" /><testcase classname="tests.sso.test_negative_security" name="test_token_substitution_audience_protection" time="0.068" /><testcase classname="tests.sso.test_negative_security" name="test_clock_skew_handling_sanity" time="0.061" /><testcase classname="tests.sso.test_negative_security" name="test_refresh_token_rotation_behavior" time="0.091"><skipped type="pytest.skip" message="Rotation expectation not configured (set SSO_EXPECT_REFRESH_ROTATION=true|false to enforce)">/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial/tests/sso/test_negative_security.py:194: Rotation expectation not configured (set SSO_EXPECT_REFRESH_ROTATION=true|false to enforce)</skipped></testcase><testcase classname="tests.sso.test_negative_security" name="test_logout_capabilities_discovery" time="0.006" /><testcase classname="tests.sso.test_smoke_config" name="test_openid_configuration_reachable_for_each_realm" time="0.007" /><testcase classname="tests.sso.test_smoke_config" name="test_jwks_endpoint_reachable_and_keys_parseable" time="0.012" /><testcase classname="tests.sso.test_smoke_config" name="test_client_redirect_uris_match_inventory" time="0.001" /><testcase classname="tests.sso.test_smoke_config" name="test_auth_code_pkce_token_exchange_per_client" time="0.177" /><testcase classname="tests.sso.test_smoke_config" name="test_https_enforcement_when_required" time="0.000"><skipped type="pytest.skip" message="HTTPS enforcement check disabled (SSO_REQUIRE_HTTPS=false)">/Users/karelgoense/Documents/programming/FreshMinds_Programming/production/ai_trial/tests/sso/test_smoke_config.py:119: HTTPS enforcement check disabled (SSO_REQUIRE_HTTPS=false)</skipped></testcase><testcase classname="tests.sso.test_smoke_config" name="test_logout_endpoint_published" time="0.045" /></testsuite></testsuites>