apiVersion: apps/v1
kind: Deployment
metadata:
  name: oauth2-proxy
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: oauth2-proxy
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: oauth2-proxy
  template:
    metadata:
      labels:
        app.kubernetes.io/name: oauth2-proxy
    spec:
      containers:
        - name: oauth2-proxy
          image: quay.io/oauth2-proxy/oauth2-proxy:v7.7.1
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 4180
              name: http
          envFrom:
            - secretRef:
                name: oauth2-proxy-secret
          args:
            - --provider=oidc
            - --oidc-issuer-url=__OIDC_ISSUER_URL__
            - --skip-oidc-discovery=true
            - --login-url=__KEYCLOAK_BROWSER_URL__/realms/odp/protocol/openid-connect/auth
            - --redeem-url=__KEYCLOAK_INTERNAL_URL__/realms/odp/protocol/openid-connect/token
            - --oidc-jwks-url=__KEYCLOAK_INTERNAL_URL__/realms/odp/protocol/openid-connect/certs
            - --http-address=0.0.0.0:4180
            - --upstream=static://202
            - --email-domain=*
            - --scope=openid profile email
            - --skip-provider-button=true
            - --redirect-url=http://auth.__HOST_BASE__:__INGRESS_PORT__/oauth2/callback
            - --cookie-name=_odp_sso
            - --cookie-domain=.__HOST_BASE__
            - --cookie-secure=false
            - --cookie-samesite=lax
            - --cookie-refresh=1h
            - --cookie-expire=12h
            - --set-xauthrequest=true
            - --reverse-proxy=true
            - --pass-access-token=true
            - --pass-authorization-header=true
            - --whitelist-domain=.__HOST_BASE__
            - --whitelist-domain=.__HOST_BASE__:__INGRESS_PORT__
            - --ping-path=/ping
            - --client-id=$(OAUTH2_PROXY_CLIENT_ID)
            - --client-secret=$(OAUTH2_PROXY_CLIENT_SECRET)
            - --cookie-secret=$(OAUTH2_PROXY_COOKIE_SECRET)
          readinessProbe:
            httpGet:
              path: /ping
              port: 4180
            initialDelaySeconds: 3
            periodSeconds: 10
            timeoutSeconds: 3
          livenessProbe:
            httpGet:
              path: /ping
              port: 4180
            initialDelaySeconds: 10
            periodSeconds: 20
            timeoutSeconds: 3
---
apiVersion: v1
kind: Service
metadata:
  name: oauth2-proxy
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: oauth2-proxy
spec:
  selector:
    app.kubernetes.io/name: oauth2-proxy
  ports:
    - name: http
      port: 4180
      targetPort: 4180
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gateway-auth
  namespace: __NAMESPACE__
  annotations:
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
    nginx.ingress.kubernetes.io/upstream-vhost: "auth.__HOST_BASE__"
spec:
  ingressClassName: nginx
  rules:
    - host: auth.__HOST_BASE__
      http:
        paths:
          - path: /oauth2
            pathType: Prefix
            backend:
              service:
                name: oauth2-proxy
                port:
                  number: 4180
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gateway-keycloak
  namespace: __NAMESPACE__
spec:
  ingressClassName: nginx
  rules:
    - host: keycloak.__HOST_BASE__
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: keycloak
                port:
                  number: 8090
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gateway-protected
  namespace: __NAMESPACE__
  annotations:
    nginx.ingress.kubernetes.io/auth-url: "http://oauth2-proxy.__NAMESPACE__.svc.cluster.local:4180/oauth2/auth"
    nginx.ingress.kubernetes.io/auth-signin: "http://auth.__HOST_BASE__:__INGRESS_PORT__/oauth2/start?rd=$scheme://$http_host$escaped_request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Auth-Request-User,X-Auth-Request-Email,Authorization"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
spec:
  ingressClassName: nginx
  rules:
    - host: airflow.__HOST_BASE__
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: airflow-webserver
                port:
                  number: 8080
    - host: superset.__HOST_BASE__
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: superset
                port:
                  number: 8088
    - host: datahub.__HOST_BASE__
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: datahub-frontend
                port:
                  number: 9002
    - host: minio.__HOST_BASE__
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: minio
                port:
                  number: 9001
    - host: portal.__HOST_BASE__
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: portal
                port:
                  number: 3000
    - host: grafana.__HOST_BASE__
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 3000
    - host: prometheus.__HOST_BASE__
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: prometheus
                port:
                  number: 9090
    - host: jupyter.__HOST_BASE__
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: jupyter
                port:
                  number: 8888
