apiVersion: apps/v1
kind: Deployment
metadata:
  name: airflow-scheduler
  namespace: odp-dev
  labels:
    app.kubernetes.io/name: airflow-scheduler
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: airflow-scheduler
  template:
    metadata:
      labels:
        app.kubernetes.io/name: airflow-scheduler
    spec:
      containers:
        - name: airflow-scheduler
          image: ai-trial/airflow:dev
          imagePullPolicy: IfNotPresent
          envFrom:
            - secretRef:
                name: odp-env
          env:
            - name: AIRFLOW__CORE__EXECUTOR
              value: LocalExecutor
            - name: AIRFLOW__CORE__LOAD_EXAMPLES
              value: "False"
            - name: AIRFLOW__METRICS__STATSD_ON
              value: "False"
            - name: OTEL_ENABLED
              valueFrom:
                secretKeyRef:
                  name: odp-env
                  key: OTEL_ENABLED
                  optional: true
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: odp-env
                  key: OTEL_EXPORTER_OTLP_ENDPOINT
                  optional: true
            - name: OTEL_METRICS_EXPORT_INTERVAL
              valueFrom:
                secretKeyRef:
                  name: odp-env
                  key: OTEL_METRICS_EXPORT_INTERVAL
                  optional: true
            - name: OTEL_SERVICE_NAMESPACE
              valueFrom:
                secretKeyRef:
                  name: odp-env
                  key: OTEL_SERVICE_NAMESPACE
                  optional: true
            - name: ENVIRONMENT
              value: local
            - name: PYTHONPATH
              value: /opt/airflow/project
            - name: USE_DATAHUB
              value: "false"
            - name: MINIO_ENDPOINT
              value: http://minio:9000
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: odp-env
                  key: MINIO_ROOT_USER
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: odp-env
                  key: MINIO_ROOT_PASSWORD
            - name: WAREHOUSE_HOST
              value: warehouse
            - name: WAREHOUSE_PORT
              value: "5432"
            - name: WAREHOUSE_DB
              valueFrom:
                secretKeyRef:
                  name: odp-env
                  key: WAREHOUSE_DB
            - name: WAREHOUSE_USER
              valueFrom:
                secretKeyRef:
                  name: odp-env
                  key: WAREHOUSE_USER
            - name: WAREHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: odp-env
                  key: WAREHOUSE_PASSWORD
          command: ["/bin/bash", "-ec"]
          args:
            - |
              set -euo pipefail
              export AIRFLOW__CORE__SQL_ALCHEMY_CONN="postgresql+psycopg2://${AIRFLOW_DB_USER}:${AIRFLOW_DB_PASSWORD}@postgres/${AIRFLOW_DB_NAME:-airflow}"
              export AIRFLOW__DATABASE__SQL_ALCHEMY_CONN="$AIRFLOW__CORE__SQL_ALCHEMY_CONN"
              export AIRFLOW__CORE__FERNET_KEY="${AIRFLOW_FERNET_KEY}"
              exec airflow scheduler
          livenessProbe:
            exec:
              command:
                - "bash"
                - "-ec"
                - |
                  export AIRFLOW__CORE__SQL_ALCHEMY_CONN="postgresql+psycopg2://${AIRFLOW_DB_USER}:${AIRFLOW_DB_PASSWORD}@postgres/${AIRFLOW_DB_NAME:-airflow}"
                  export AIRFLOW__DATABASE__SQL_ALCHEMY_CONN="$AIRFLOW__CORE__SQL_ALCHEMY_CONN"
                  airflow jobs check --job-type SchedulerJob --hostname "$(hostname)"
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          volumeMounts:
            - name: dags
              mountPath: /opt/airflow/dags
            - name: logs
              mountPath: /opt/airflow/logs
            - name: plugins
              mountPath: /opt/airflow/plugins
            - name: project
              mountPath: /opt/airflow/project
      volumes:
        - name: dags
          hostPath:
            path: /workspace/ai_trial/dags
            type: Directory
        - name: logs
          emptyDir: {}
        - name: plugins
          hostPath:
            path: /workspace/ai_trial/plugins
            type: DirectoryOrCreate
        - name: project
          hostPath:
            path: /workspace/ai_trial
            type: Directory
