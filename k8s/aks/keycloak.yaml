apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-realm
  namespace: __NAMESPACE__
data:
  odp-realm.json: |-
    {
        "realm": "odp",
        "displayName": "Open Data Platform",
        "enabled": true,
        "clients": [
            {
                "clientId": "airflow",
                "name": "Airflow",
                "enabled": true,
                "protocol": "openid-connect",
                "publicClient": false,
                "secret": "${KEYCLOAK_AIRFLOW_CLIENT_SECRET}",
                "standardFlowEnabled": true,
                "directAccessGrantsEnabled": true,
                "redirectUris": [
                    "https://airflow.__FRONTEND_DOMAIN__/oauth-authorized/keycloak",
                    "https://airflow.__FRONTEND_DOMAIN__/auth/oauth-authorized/keycloak"
                ],
                "webOrigins": [
                    "https://airflow.__FRONTEND_DOMAIN__"
                ],
                "protocolMappers": [
                    {
                        "name": "airflow-audience",
                        "protocol": "openid-connect",
                        "protocolMapper": "oidc-audience-mapper",
                        "config": {
                            "included.client.audience": "airflow",
                            "access.token.claim": "true",
                            "id.token.claim": "false",
                            "userinfo.token.claim": "false"
                        }
                    }
                ]
            },
            {
                "clientId": "datahub",
                "name": "DataHub",
                "enabled": true,
                "protocol": "openid-connect",
                "publicClient": false,
                "secret": "${KEYCLOAK_DATAHUB_CLIENT_SECRET}",
                "standardFlowEnabled": true,
                "directAccessGrantsEnabled": true,
                "redirectUris": [
                    "https://datahub.__FRONTEND_DOMAIN__/callback/oidc"
                ],
                "webOrigins": [
                    "https://datahub.__FRONTEND_DOMAIN__"
                ],
                "protocolMappers": [
                    {
                        "name": "datahub-audience",
                        "protocol": "openid-connect",
                        "protocolMapper": "oidc-audience-mapper",
                        "config": {
                            "included.client.audience": "datahub",
                            "access.token.claim": "true",
                            "id.token.claim": "false",
                            "userinfo.token.claim": "false"
                        }
                    }
                ]
            },
            {
                "clientId": "minio",
                "name": "MinIO Console",
                "enabled": true,
                "protocol": "openid-connect",
                "publicClient": false,
                "secret": "${KEYCLOAK_MINIO_CLIENT_SECRET}",
                "standardFlowEnabled": true,
                "directAccessGrantsEnabled": true,
                "redirectUris": [
                    "https://minio.__FRONTEND_DOMAIN__/oauth_callback"
                ],
                "webOrigins": [
                    "https://minio.__FRONTEND_DOMAIN__"
                ],
                "protocolMappers": [
                    {
                        "name": "minio-audience",
                        "protocol": "openid-connect",
                        "protocolMapper": "oidc-audience-mapper",
                        "config": {
                            "included.client.audience": "minio",
                            "access.token.claim": "true",
                            "id.token.claim": "false",
                            "userinfo.token.claim": "false"
                        }
                    },
                    {
                        "name": "minio-policy",
                        "protocol": "openid-connect",
                        "protocolMapper": "oidc-hardcoded-claim-mapper",
                        "config": {
                            "claim.name": "policy",
                            "claim.value": "consoleAdmin",
                            "jsonType.label": "String",
                            "access.token.claim": "true",
                            "id.token.claim": "true",
                            "userinfo.token.claim": "true"
                        }
                    }
                ]
            },
            {
                "clientId": "superset",
                "name": "Superset",
                "enabled": true,
                "protocol": "openid-connect",
                "publicClient": false,
                "secret": "${KEYCLOAK_SUPERSET_CLIENT_SECRET}",
                "standardFlowEnabled": true,
                "directAccessGrantsEnabled": true,
                "redirectUris": [
                    "https://superset.__FRONTEND_DOMAIN__/oauth-authorized/keycloak"
                ],
                "webOrigins": [
                    "https://superset.__FRONTEND_DOMAIN__"
                ],
                "protocolMappers": [
                    {
                        "name": "superset-audience",
                        "protocol": "openid-connect",
                        "protocolMapper": "oidc-audience-mapper",
                        "config": {
                            "included.client.audience": "superset",
                            "access.token.claim": "true",
                            "id.token.claim": "false",
                            "userinfo.token.claim": "false"
                        }
                    }
                ]
            },
            {
                "clientId": "grafana",
                "name": "Grafana",
                "enabled": true,
                "protocol": "openid-connect",
                "publicClient": false,
                "secret": "${KEYCLOAK_GRAFANA_CLIENT_SECRET}",
                "standardFlowEnabled": true,
                "directAccessGrantsEnabled": true,
                "redirectUris": [
                    "https://grafana.__FRONTEND_DOMAIN__/login/generic_oauth"
                ],
                "webOrigins": [
                    "https://grafana.__FRONTEND_DOMAIN__"
                ],
                "protocolMappers": [
                    {
                        "name": "grafana-audience",
                        "protocol": "openid-connect",
                        "protocolMapper": "oidc-audience-mapper",
                        "config": {
                            "included.client.audience": "grafana",
                            "access.token.claim": "true",
                            "id.token.claim": "false",
                            "userinfo.token.claim": "false"
                        }
                    }
                ]
            },
            {
                "clientId": "${KEYCLOAK_GATEWAY_CLIENT_ID}",
                "name": "Platform Gateway",
                "enabled": true,
                "protocol": "openid-connect",
                "publicClient": false,
                "secret": "${KEYCLOAK_GATEWAY_CLIENT_SECRET}",
                "standardFlowEnabled": true,
                "directAccessGrantsEnabled": true,
                "redirectUris": [
                    "https://auth.__FRONTEND_DOMAIN__/oauth2/callback"
                ],
                "webOrigins": [
                    "https://auth.__FRONTEND_DOMAIN__"
                ],
                "protocolMappers": [
                    {
                        "name": "platform-gateway-audience",
                        "protocol": "openid-connect",
                        "protocolMapper": "oidc-audience-mapper",
                        "config": {
                            "included.client.audience": "${KEYCLOAK_GATEWAY_CLIENT_ID}",
                            "access.token.claim": "true",
                            "id.token.claim": "false",
                            "userinfo.token.claim": "false"
                        }
                    }
                ]
            }
        ],
        "users": [
            {
                "username": "odp-admin",
                "enabled": true,
                "email": "admin@example.com",
                "emailVerified": true,
                "firstName": "ODP",
                "lastName": "Admin",
                "credentials": [
                    {
                        "type": "password",
                        "value": "${KEYCLOAK_DEFAULT_USER_PASSWORD}",
                        "temporary": false
                    }
                ]
            }
        ]
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: keycloak
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: keycloak
  template:
    metadata:
      labels:
        app.kubernetes.io/name: keycloak
    spec:
      initContainers:
        - name: render-realm
          image: alpine:3.20
          command: ["/bin/sh", "-c"]
          args:
            - |
              apk add --no-cache gettext >/dev/null
              export KEYCLOAK_SUPERSET_CLIENT_SECRET="${KEYCLOAK_SUPERSET_CLIENT_SECRET:-change_me_keycloak_superset_secret}"
              export KEYCLOAK_GRAFANA_CLIENT_SECRET="${KEYCLOAK_GRAFANA_CLIENT_SECRET:-change_me_keycloak_grafana_secret}"
              export KEYCLOAK_GATEWAY_CLIENT_ID="${KEYCLOAK_GATEWAY_CLIENT_ID:-platform-gateway}"
              export KEYCLOAK_GATEWAY_CLIENT_SECRET="${KEYCLOAK_GATEWAY_CLIENT_SECRET:-change_me_keycloak_gateway_secret}"
              envsubst < /realm/odp-realm.json > /import/odp-realm.json
          envFrom:
            - secretRef:
                name: odp-env
          volumeMounts:
            - name: realm-template
              mountPath: /realm
            - name: realm-import
              mountPath: /import
      containers:
        - name: keycloak
          image: quay.io/keycloak/keycloak:26.1.2
          imagePullPolicy: IfNotPresent
          args: ["start-dev", "--http-port=8090", "--import-realm"]
          ports:
            - containerPort: 8090
              name: http
          env:
            - name: KC_BOOTSTRAP_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: odp-env
                  key: KEYCLOAK_ADMIN_USER
            - name: KC_BOOTSTRAP_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: odp-env
                  key: KEYCLOAK_ADMIN_PASSWORD
            - name: KC_PROXY_HEADERS
              value: xforwarded
            - name: KC_HOSTNAME
              value: https://keycloak.__FRONTEND_DOMAIN__
          volumeMounts:
            - name: realm-import
              mountPath: /opt/keycloak/data/import
      volumes:
        - name: realm-template
          configMap:
            name: keycloak-realm
        - name: realm-import
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: keycloak
  namespace: __NAMESPACE__
  labels:
    app.kubernetes.io/name: keycloak
spec:
  selector:
    app.kubernetes.io/name: keycloak
  ports:
    - name: http
      port: 8090
      targetPort: 8090
